name: APK Build

on:
  push:
  workflow_dispatch:
    inputs:
      build_type:
        type: choice
        description: 'é€‰æ‹©ç¼–è¯‘ç±»åž‹'
        required: true
        default: 'debug'
        options:
          - 'debug'
          - 'release'

permissions:
  contents: read
  actions: read

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      build_timestamp: ${{ steps.build_info.outputs.build_timestamp }}
      build_type: ${{ steps.set_build_type.outputs.build_type }}
    env:
      NATIVE_TARGET: "arm64-v8a"
    steps:
        - name: â¬‡ï¸ Checkout Repository
          uses: actions/checkout@v4
        
        - name: ðŸ”§ è®¾ç½®æž„å»ºç±»åž‹
          id: set_build_type
          run: |
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              echo "build_type=${{ github.event.inputs.build_type }}" >> $GITHUB_OUTPUT
            else
              echo "build_type=debug" >> $GITHUB_OUTPUT
            fi
            echo "æž„å»ºç±»åž‹: ${{ steps.set_build_type.outputs.build_type }}"
    
        - name: ðŸ› ï¸ Set up Java
          uses: actions/setup-java@v4
          with:
            distribution: 'temurin'
            java-version: '17'
    
        - name: ðŸ’» Set up Android SDK and NDK
          uses: android-actions/setup-android@v3
          with:
            ndk: '28.2.13676358'
            build-tools: '35.0.0'
    
        - name: âš™ï¸ Grant execute permission to gradlew
          run: chmod +x gradlew
    
        - name: ðŸ—ï¸ Build APK
          run: |
            if [ "${{ steps.set_build_type.outputs.build_type }}" = "release" ]; then
              ./gradlew assembleRelease
            else
              ./gradlew assembleDebug
            fi
    
        - name: ðŸ“¦ Find APK file and rename
          id: build_info
          env:
            COMMIT_ID: ${{ github.sha }}
            BUILD_TYPE: ${{ steps.set_build_type.outputs.build_type }}
          run: |
            BUILD_TIMESTAMP=$(date +%s)
            echo "build_timestamp=$BUILD_TIMESTAMP" >> $GITHUB_OUTPUT

            # æ ¹æ®æž„å»ºç±»åž‹é€‰æ‹©æ­£ç¡®çš„APKç›®å½•
            if [ "$BUILD_TYPE" = "release" ]; then
              APK_DIR="release"
            else
              APK_DIR="debug"
            fi

            ORIGINAL_APK_PATH=$(find ${{ github.workspace }}/app/build/outputs/apk/$APK_DIR/ -name "*.apk" | head -n 1)
            COMMIT_ID_SHORT=${COMMIT_ID::7}
            NEW_APK_NAME="RikoNyamu-${{ env.NATIVE_TARGET }}-${BUILD_TYPE}-${COMMIT_ID_SHORT}.apk"
            
            # é‡å‘½å APK æ–‡ä»¶
            NEW_APK_DIR=$(dirname "$ORIGINAL_APK_PATH")
            NEW_APK_PATH="$NEW_APK_DIR/$NEW_APK_NAME"
            mv "$ORIGINAL_APK_PATH" "$NEW_APK_PATH"
            echo "apk_path=$NEW_APK_PATH" >> $GITHUB_OUTPUT
            echo "Found and renamed APK to: $NEW_APK_PATH"
    
        - name: ðŸ“¤ Upload APK Artifact
          uses: actions/upload-artifact@v4
          with:
            name: RikoNyamu-${{ steps.set_build_type.outputs.build_type }}
            path: ${{ steps.build_info.outputs.apk_path }}
            retention-days: 7
